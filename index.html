<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>宜蘭漁港動態水質監測圖</title>

    <script type="text/javascript"
        src="https://api.tgos.tw/TGOS_API/tgos?ver=2&AppID=x+JLVSx85Lk=&APIKey=in8W74q0ogpcfW/STwicK8D5QwCdddJf05/7nb+OtDh8R99YN3T0LurV4xato3TpL/fOfylvJ9Wv/khZEsXEWxsBmg+GEj4AuokiNXCh14Rei21U5GtJpIkO++Mq3AguFK/ISDEWn4hMzqgrkxNe1Q=="
        charset="utf-8"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; background: #f4f4f4; }
        /* 地圖區 */
        #MapDiv {
            position: absolute;
            top: 10px;
            left: 10px;
            width: calc(100% - 550px);
            height: calc(100vh - 20px);
            border: 1px solid #333;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
        }
        /* 右側控制面板 */
        #controlPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 510px;
            height: calc(100vh - 20px);
            background: #fff;
            border: 1px solid #ccc;
            padding: 15px;
            box-sizing: border-box;
            overflow: auto;
            z-index: 999;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        h2, h3 { color: #2c3e50; margin-top: 0; }
        .row { margin-bottom: 15px; }
        select { padding: 5px; width: 200px; }
        button { padding: 6px 12px; cursor: pointer; background: #3498db; color: #fff; border: none; border-radius: 4px; }
        button:hover { background: #2980b9; }
        canvas { background: #fff; margin-bottom: 20px; border: 1px solid #eee; }
        .small-note { font-size: 12px; color: #666; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
        #currentPort { font-weight: bold; color: #e74c3c; font-size: 18px; }
    </style>
</head>
<body onload="InitAll();">

<div id="MapDiv"></div>

<div id="controlPanel">
    <h2>漁港水質控制面板</h2>

    <div class="row">
        <button onclick="InitAll()">重新載入資料</button>
        <span class="small-note">（點擊以強制讀取最新 CSV）</span>
    </div>

    <div class="row">
        <label for="portSelect"><b>選擇漁港：</b></label>
        <select id="portSelect" onchange="onPortChange()">
            <option value="">-- 請選擇港口 --</option>
        </select>
    </div>

    <div class="row">
        <b>目前顯示：</b> <span id="currentPort">請選擇港口</span>
    </div>

    <hr>

    <h3>pH 值時序趨勢圖</h3>
    <canvas id="phChart" width="470" height="240"></canvas>

    <h3>DO 溶氧量時序圖 (mg/L)</h3>
    <canvas id="doChart" width="470" height="240"></canvas>

    <div class="row small-note">
        資料來源：<code>water_quality.csv</code><br>
        系統座標系：TWD97 (EPSG:3826)
    </div>
</div>

<script>
/* ----------------------------
    全域變數與 14 漁港座標定義
   ---------------------------- */
var map = null;
var csvData = []; 
var markers = {}; 
var infoWindows = {}; 
var phChart = null, doChart = null;

// 已經根據您提供的經緯度換算為 TWD97 (EPSG:3826)
var portsCoords = {
    "梗枋漁港": { x: 337898.4, y: 2755463.9 },
    "烏石港": { x: 334358.5, y: 2750928.9 },
    "大溪第一漁港": { x: 340901.8, y: 2759624.4 },
    "大溪第二漁港": { x: 340968.9, y: 2759546.8 },
    "蕃薯寮漁港": { x: 342563.8, y: 2760805.5 },
    "大里漁港": { x: 343220.0, y: 2761946.8 },
    "石城漁港": { x: 346200.7, y: 2763897.6 },
    "桶盤堀漁港": { x: 344719.1, y: 2763183.0 },
    "蘇澳港": { x: 337357.7, y: 2720456.9 },
    "南方澳第三漁港": { x: 337508.2, y: 2720049.9 },
    "南方澳第一漁港": { x: 337609.1, y: 2719860.5 },
    "南方澳第二漁港": { x: 337695.5, y: 2719360.5 },
    "粉鳥林漁港": { x: 335186.0, y: 2710502.8 },
    "朝陽漁港": { x: 332832.6, y: 2706456.8 }
};

/* ----------------------------
    1. 初始化與讀取 CSV
   ---------------------------- */
function InitAll() {
    var csvUrl = 'water_quality.csv?t=' + Date.now(); 
    fetch(csvUrl)
        .then(function(resp){
            if(!resp.ok) throw new Error('找不到 CSV 檔案');
            return resp.text();
        })
        .then(function(txt){
            var parsed = Papa.parse(txt, { header: true, skipEmptyLines: true });
            csvData = parsed.data.map(function(r){
                return {
                    port: String(r.port || "").trim(),
                    year: String(r.year || "").trim(),
                    month: String(r.month || "").trim(),
                    ph: String(r.ph || "").trim(),
                    do: String(r.do || "").trim()
                };
            });
            console.log("CSV 載入成功，筆數：", csvData.length);
            
            buildPortDropdown();
            
            if (!map) {
                InitMap();
            } else {
                createMarkersFromConfig();
            }
        })
        .catch(function(err){
            console.error(err);
            alert("錯誤：無法載入 water_quality.csv。請確認檔案格式與名稱是否正確。");
        });
}

/* ----------------------------
    2. 建立下拉選單
   ---------------------------- */
function buildPortDropdown(){
    var sel = document.getElementById('portSelect');
    var currentVal = sel.value; // 保留當前選擇
    sel.innerHTML = '<option value="">-- 請選擇港口 --</option>';

    // 從 CSV 中取出所有不重複的港口名稱
    var portsInCSV = Array.from(new Set(csvData.map(r => r.port))).filter(p => p !== "");
    
    // 如果 CSV 沒資料，也顯示我們定義的 14 個港口
    var allPorts = Array.from(new Set([...portsInCSV, ...Object.keys(portsCoords)])).sort();

    allPorts.forEach(function(p){
        var opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        sel.appendChild(opt);
    });
    if(currentVal) sel.value = currentVal;
}

/* ----------------------------
    3. 初始化 TGOS 地圖
   ---------------------------- */
function InitMap() {
    var mapDiv = document.getElementById('MapDiv');
    var mapOptions = {
        scaleControl: true,
        navigationControl: true,
        navigationControlOptions: {
            controlPosition: TGOS.TGControlPosition.TOP_LEFT,
            navigationControlStyle: TGOS.TGNavigationControlStyle.SMALL
        },
        mapTypeControl: false
    };

    // 中心點設在宜蘭中間位置 (TWD97)
    var yilanCenter = new TGOS.TGPoint(336500, 2735000);
    map = new TGOS.TGOnlineMap(mapDiv, TGOS.TGCoordSys.EPSG3826, mapOptions);
    map.setCenter(yilanCenter);
    map.setZoom(10); // 縮放至可見全宜蘭港口

    createMarkersFromConfig();
}

/* ----------------------------
    4. 建立地圖標記 (Markers)
   ---------------------------- */
function createMarkersFromConfig(){
    // 清除舊標記
    for (var key in markers) { try { markers[key].setMap(null); } catch(e){} }
    markers = {}; infoWindows = {};

    var iconUrl = "https://api.tgos.tw/TGOS_API/images/marker2.png";
    var markerImg = new TGOS.TGImage(iconUrl, new TGOS.TGSize(38,33), new TGOS.TGPoint(0,0), new TGOS.TGPoint(10,33));

    Object.keys(portsCoords).forEach(function(portName){
        var c = portsCoords[portName];
        var p = new TGOS.TGPoint(c.x, c.y);
        var marker = new TGOS.TGMarker(map, p, portName, markerImg);
        markers[portName] = marker;

        var html = "<div style='padding:5px;'><b>" + portName + "</b><br>點擊查看水質趨勢圖</div>";
        var iw = new TGOS.TGInfoWindow(html, p, { maxWidth: 200 });
        infoWindows[portName] = iw;

        TGOS.TGEvent.addListener(marker, "click", function(){
            selectPort(portName);
        });
    });
}

/* ----------------------------
    5. 選取港口後的連動邏輯
   ---------------------------- */
function onPortChange(){
    var port = document.getElementById('portSelect').value;
    if (port) selectPort(port);
}

function selectPort(portName) {
    document.getElementById('currentPort').textContent = portName;
    document.getElementById('portSelect').value = portName;

    if (markers[portName]) {
        map.setCenter(markers[portName].getPosition());
        // 關閉所有視窗再開啟目前的
        for (var k in infoWindows) infoWindows[k].close();
        infoWindows[portName].open(map);
    } else {
        console.warn("座標清單中找不到：" + portName);
    }

    drawChartsForPort(portName);
}

/* ----------------------------
    6. 繪製 Chart.js 圖表
   ---------------------------- */
function drawChartsForPort(portName){
    // 篩選並排序資料
    var rows = csvData.filter(r => r.port === portName);
    rows.sort((a, b) => (parseInt(a.year)*100 + parseInt(a.month)) - (parseInt(b.year)*100 + parseInt(b.month)));

    if (rows.length === 0) {
        destroyCharts();
        alert(portName + " 目前無 CSV 資料。");
        return;
    }

    var labels = rows.map(r => r.year + "/" + (parseInt(r.month)<10 ? '0'+r.month : r.month));
    var phVals = rows.map(r => parseFloat(r.ph));
    var doVals = rows.map(r => parseFloat(r.do));

    // pH 圖表
    if (phChart) phChart.destroy();
    phChart = new Chart(document.getElementById('phChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{ label: 'pH 值', data: phVals, borderColor: '#e67e22', tension: 0.1, fill: false, borderWidth: 3 }]
        },
        options: { responsive: false, scales: { y: { min: 6, max: 10 } } }
    });

    // DO 圖表
    if (doChart) doChart.destroy();
    doChart = new Chart(document.getElementById('doChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{ label: '溶氧量 (mg/L)', data: doVals, borderColor: '#3498db', tension: 0.1, fill: false, borderWidth: 3 }]
        },
        options: { responsive: false, scales: { y: { min: 0, max: 12 } } }
    });
}

function destroyCharts(){
    if (phChart) phChart.destroy();
    if (doChart) doChart.destroy();
}
</script>

</body>
</html>

</html>

